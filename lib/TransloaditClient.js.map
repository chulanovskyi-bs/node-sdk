{"version":3,"sources":["../src/TransloaditClient.js"],"names":["reqr","global","GENTLY","hijack","require","request","crypto","_","fs","path","retry","PaginationStream","Readable","tus","unknownErrMsg","TransloaditClient","opts","useSsl","authKey","Error","authSecret","_authKey","_authSecret","_service","service","_protocol","_streams","_tus_streams","_lastUsedAssemblyUrl","name","stream","pause","createReadStream","on","console","error","err","addStream","cb","progressCb","defaultOpts","params","fields","waitForCompletion","isResumable","extend","callback","called","result","_serviceUrl","streams","label","push","requestOpts","url","method","timeout","tus_num_expected_upload_files","length","Object","keys","sendRequest","_remoteJson","awaitAssemblyCompletion","assembly_id","tusOpts","_sendTusRequest","ncompleted","streamErrCb","Array","from","access","F_OK","R_OK","assemblyId","getAssembly","ok","setTimeout","assemblyProgress","assembly_url","notifyUrl","notify_url","pageno","listAssemblyNotifications","page","listAssemblies","retryOpts","retries","factor","minTimeout","maxTimeout","operation","attempt","mainError","assembly_ssl_url","left","message","templateId","listTemplates","month","jsonParams","_prepareParams","signature","_calcSignature","toSign","createHmac","update","Buffer","digest","req","sigData","calcSignature","form","append","key","val","isObject","isArray","JSON","stringify","each","value","indexOf","encodeURIComponent","auth","expires","_getExpiresDate","expiresDate","Date","setDate","getDate","toISOString","__remoteJson","warn","info","retryIn","_timeouts","unshift","code","undefined","msg","join","_appendParamsToUrl","uri","headers","body","statusCode","parse","e","abbr","substr","extraData","_appendForm","onProgress","uploadsDone","streamLabels","tlClient","totalBytes","uploadedBytes","file","uploadSize","statSync","size","filename","basename","tusUpload","Upload","endpoint","tus_url","resume","metadata","fieldname","onError","bytesUploaded","uploadProgress","onSuccess","start","module","exports"],"mappings":"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","file":"TransloaditClient.js","sourcesContent":["const reqr = global.GENTLY ? GENTLY.hijack(require) : require\nconst request = reqr('request')\nconst crypto = reqr('crypto')\nconst _ = reqr('underscore')\nconst fs = reqr('fs')\nconst path = reqr('path')\nconst retry = reqr('retry')\nconst PaginationStream = reqr('./PaginationStream')\nconst Readable = reqr('stream').Readable\nconst tus = reqr('tus-js-client')\n\nlet unknownErrMsg = 'Unknown error. Please report this at '\nunknownErrMsg += 'https://github.com/transloadit/node-sdk/issues/new?title=Unknown%20error'\n\nclass TransloaditClient {\n  constructor (opts = {}) {\n    if (opts.useSsl == null) {\n      opts.useSsl = true\n    }\n\n    if (opts.authKey == null) {\n      throw new Error('Please provide an authKey')\n    }\n\n    if (opts.authSecret == null) {\n      throw new Error('Please provide an authSecret')\n    }\n\n    this._authKey = opts.authKey\n    this._authSecret = opts.authSecret\n    this._service = opts.service || 'api2.transloadit.com'\n    this._protocol = opts.useSsl ? 'https://' : 'http://'\n    this._streams = {}\n    this._tus_streams = {}\n\n    this._lastUsedAssemblyUrl = ''\n  }\n\n  /**\n   * Adds an Assembly file stream\n   *\n   * @param {string} name fieldname of the file\n   * @param {ReadableStream} stream stream to be uploaded\n   */\n  addStream (name, stream) {\n    stream.pause()\n    this._streams[name] = stream\n  }\n\n  /**\n   * Adds an Assembly file\n   *\n   * @param {string} name field name of the file\n   * @param {string} path path to the file\n   */\n  addFile (name, path) {\n    const stream = fs.createReadStream(path)\n    stream.on('error', err => {\n      // handle the error event to avoid the error being thrown\n      console.error(err)\n    })\n    this.addStream(name, stream)\n  }\n\n  getLastUsedAssemblyUrl () {\n    return this._lastUsedAssemblyUrl\n  }\n\n  /**\n   * Create an Assembly\n   *\n   * @typedef {object} progressObject\n   * @property {object} assemblyProgress\n   * @property {{totalBytes: number, uploadedBytes: number}} uploadProgress\n   *\n   * @callback onProgress\n   * @param {progressObject} progress\n   *\n   * @param {object} opts assembly options\n   * @param {function} cb callback function for when assembly is submitted/done\n   * @param {onProgress} progressCb callback function to be triggered as on each progress update of the assembly\n   */\n  createAssembly (opts, cb, progressCb) {\n    const defaultOpts = {\n      params: {},\n      fields: {},\n      waitForCompletion: false,\n      isResumable: true\n    }\n    opts = _.extend(defaultOpts, opts)\n\n    let stream\n    const callback = cb\n    let called = false\n    cb = (err, result) => {\n      if (!called) {\n        called = true\n        callback(err, result)\n      }\n    }\n\n    this._lastUsedAssemblyUrl = `${this._serviceUrl()}/assemblies`\n\n    const streams = (() => {\n      const result = []\n      for (let label in this._streams) {\n        stream = this._streams[label]\n        result.push(stream)\n      }\n      return result\n    })()\n\n    let requestOpts = {\n      url: this._lastUsedAssemblyUrl,\n      method: 'post',\n      timeout: 24 * 60 * 60 * 1000, // 1 day\n      params: opts.params,\n      fields: opts.fields,\n    }\n\n    if (opts.isResumable) {\n      requestOpts.tus_num_expected_upload_files = streams.length\n      // transfer streams to tus streams so they don't get uploaded as multipart\n      for (const label of Object.keys(this._streams)) {\n        this._tus_streams[label] = this._streams[label]\n        delete this._streams[label]\n      }\n    }\n\n    const sendRequest = () => {\n      this._remoteJson(requestOpts, (err, result = {}) => {\n        // reset streams so they do not get used again in subsequent requests\n        this._streams = {}\n\n        if (!err && result.error != null) {\n          err = new Error(result.error)\n        }\n\n        if (err) {\n          return cb(err)\n        }\n\n        if (!opts.isResumable) {\n          if (!opts.waitForCompletion) {\n            return cb(null, result)\n          }\n\n          return this.awaitAssemblyCompletion(result.assembly_id, cb, progressCb)\n        }\n\n        const tusOpts = Object.assign({ waitForCompletion: opts.waitForCompletion }, result)\n        this._sendTusRequest(tusOpts, cb, progressCb)\n      })\n    }\n\n    let ncompleted = 0\n    const streamErrCb = err => {\n      if (err != null) {\n        cb(err)\n      }\n\n      if (++ncompleted === streams.length) {\n        sendRequest()\n      }\n    }\n\n    for (stream of Array.from(streams)) {\n      stream.on('error', cb)\n\n      // because an http response stream could also have a \"path\"\n      // attribute but not referring to the local file system\n      // see https://github.com/transloadit/node-sdk/pull/50#issue-261982855\n      if (stream.path == null || !(stream instanceof Readable)) {\n        streamErrCb(null)\n        continue\n      }\n\n      fs.access(stream.path, fs.F_OK | fs.R_OK, err => {\n        if (err != null) {\n          return streamErrCb(err)\n        }\n\n        streamErrCb(null)\n      })\n    }\n\n    // make sure sendRequest gets called when there are no @_streams\n    if (streams.length === 0) {\n      sendRequest()\n    }\n  }\n\n  awaitAssemblyCompletion (assemblyId, cb, progressCb) {\n    this.getAssembly(assemblyId, (err, result) => {\n      if (!err && result.error != null) {\n        err = new Error(result.error)\n      }\n\n      if (err) {\n        return cb(err)\n      }\n\n      if (result.ok === 'ASSEMBLY_COMPLETED') {\n        return cb(null, result)\n      }\n\n      if (result.ok === 'ASSEMBLY_UPLOADING' || result.ok === 'ASSEMBLY_EXECUTING') {\n        setTimeout(() => {\n          this.awaitAssemblyCompletion(assemblyId, cb)\n        }, 1 * 1000)\n\n        if (progressCb) {\n          progressCb({assemblyProgress: result})\n        }\n\n        return\n      }\n\n      return cb(new Error(unknownErrMsg))\n    })\n  }\n\n  /**\n   * Delete the assembly\n   *\n   * @param {string} assemblyId assembly ID\n   * @param {function} cb callback function after the assembly is deleted\n   */\n  deleteAssembly (assemblyId, cb) {\n    this.getAssembly(assemblyId, (err, { assembly_url } = {}) => {\n      if (err != null) {\n        return cb(err)\n      }\n\n      const opts = {\n        url    : assembly_url,\n        timeout: 5000,\n        method : 'del',\n        params : {},\n      }\n\n      this._remoteJson(opts, cb)\n    })\n  }\n\n  /**\n   * Replay an Assembly\n   *\n   * @typedef {object} replayOptions\n   * @property {string} assembly_id\n   * @property {string} notify_url\n   *\n   * @param {replayOptions} opts options defining the Assembly to replay\n   * @param {function} cb callback function after the replay is started\n   */\n  replayAssembly (opts, cb) {\n    const { assembly_id: assemblyId, notify_url: notifyUrl } = opts\n    const requestOpts = {\n      url   : this._serviceUrl() + `/assemblies/${assemblyId}/replay`,\n      method: 'post',\n    }\n\n    if (notifyUrl != null) {\n      requestOpts.params = { notifyUrl }\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  /**\n   * Replay an Assembly notification\n   *\n   * @param {replayOptions} opts options defining the Assembly to replay\n   * @param {function} cb callback function after the replay is started\n   */\n  replayAssemblyNotification ({ assembly_id: assemblyId, notify_url: notifyUrl }, cb) {\n    const requestOpts = {\n      url   : this._serviceUrl() + `/assembly_notifications/${assemblyId}/replay`,\n      method: 'post',\n    }\n\n    if (notifyUrl != null) {\n      requestOpts.params = { notifyUrl }\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  /**\n   * List all assembly notifications\n   *\n   * @param {object} params optional request options\n   * @param {function} cb callback function triggered with the list of Assembly notifications\n   */\n  listAssemblyNotifications (params, cb) {\n    const requestOpts = {\n      url   : `${this._serviceUrl()}/assembly_notifications`,\n      method: 'get',\n      params: params || {},\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  streamAssemblyNotifications (params) {\n    return new PaginationStream((pageno, cb) => {\n      this.listAssemblyNotifications(_.extend({}, params, { page: pageno }), cb)\n    })\n  }\n\n  /**\n   * List all assemblies\n   *\n   * @param {object} params optional request options\n   * @param {function} cb callback function triggered with the list of Assemblies\n   */\n  listAssemblies (params, cb) {\n    const requestOpts = {\n      url   : `${this._serviceUrl()}/assemblies`,\n      method: 'get',\n      params: params || {},\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  streamAssemblies (params) {\n    return new PaginationStream((pageno, cb) => {\n      this.listAssemblies(_.extend({}, params, { page: pageno }), cb)\n    })\n  }\n\n  /**\n   * Get an Assembly\n   *\n   * @param {string} assemblyId the Assembly Id\n   * @param {function} cb callback function triggered with the retrieved Assembly\n   */\n  getAssembly (assemblyId, cb) {\n    const opts = { url: this._serviceUrl() + `/assemblies/${assemblyId}` }\n\n    const retryOpts = {\n      retries   : 5,\n      factor    : 3.28,\n      minTimeout: 1 * 1000,\n      maxTimeout: 8 * 1000,\n    }\n\n    const operation = retry.operation(retryOpts)\n    operation.attempt(attempt => {\n      this._remoteJson(opts, (err, result) => {\n        if (err != null) {\n          if (operation.retry(err)) {\n            return\n          }\n\n          return cb(operation.mainError())\n        }\n\n        if (result.assembly_url == null || result.assembly_ssl_url == null) {\n          if (operation.retry(new Error('got incomplete assembly status response'))) {\n            return\n          }\n\n          return cb(operation.mainError())\n        }\n\n        cb(null, result)\n      })\n    })\n  }\n\n  /**\n   * Create an Assembly Template\n   *\n   * @param {object} params optional request options\n   * @param {function} cb callback function triggered when the template is created\n   */\n  createTemplate (params, cb) {\n    const requestOpts = {\n      url   : `${this._serviceUrl()}/templates`,\n      method: 'post',\n      params: params || {},\n    }\n\n    this._remoteJson(requestOpts, (err, result) => {\n      let left\n      if (err) {\n        return cb(err)\n      }\n\n      if (result && result.ok) {\n        return cb(null, result)\n      }\n\n      err = new Error((left = result.error != null ? result.error : result.message) != null ? left : unknownErrMsg)\n      cb(err)\n    })\n  }\n\n  /**\n   * Edit an Assembly Template\n   *\n   * @param {string} templateId the template ID\n   * @param {object} params optional request options\n   * @param {function} cb callback function triggered when the template is edited\n   */\n  editTemplate (templateId, params, cb) {\n    const requestOpts = {\n      url   : `${this._serviceUrl()}/templates/${templateId}`,\n      method: 'put',\n      params: params || {},\n    }\n\n    this._remoteJson(requestOpts, (err, result) => {\n      let left\n      if (err) {\n        return cb(err)\n      }\n\n      if (result && result.ok) {\n        return cb(null, result)\n      }\n\n      err = new Error((left = result.error != null ? result.error : result.message) != null ? left : unknownErrMsg)\n      cb(err)\n    })\n  }\n\n  /**\n   * Delete an Assembly Template\n   *\n   * @param {string} templateId the template ID\n   * @param {function} cb callback function triggered when the template is deleted\n   */\n  deleteTemplate (templateId, cb) {\n    const requestOpts = {\n      url   : this._serviceUrl() + `/templates/${templateId}`,\n      method: 'del',\n      params: {},\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  /**\n   * Get an Assembly Template\n   *\n   * @param {string} templateId the template ID\n   * @param {function} cb callback function triggered when the template is retrieved\n   */\n  getTemplate (templateId, cb) {\n    const requestOpts = {\n      url   : `${this._serviceUrl()}/templates/${templateId}`,\n      method: 'get',\n      params: {},\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  /**\n   * List all Assembly Templates\n   *\n   * @param {object} params optional request options\n   * @param {function} cb callback function triggered when the templates are retrieved\n   */\n  listTemplates (params, cb) {\n    const requestOpts = {\n      url   : `${this._serviceUrl()}/templates`,\n      method: 'get',\n      params: params || {},\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  streamTemplates (params) {\n    return new PaginationStream((pageno, cb) => {\n      this.listTemplates(_.extend({}, params, { page: pageno }), cb)\n    })\n  }\n\n  /**\n   * Get account Billing details for a specific month\n   *\n   * @param {string} month the date for the required billing in the format yyyy-mm\n   * @param {function} cb callback function triggered when the billing is retrieved\n   */\n  getBill (month, cb) {\n    const requestOpts = {\n      url   : this._serviceUrl() + `/bill/${month}`,\n      method: 'get',\n      params: {},\n    }\n\n    this._remoteJson(requestOpts, cb)\n  }\n\n  calcSignature (params) {\n    const jsonParams = this._prepareParams(params)\n    const signature = this._calcSignature(jsonParams)\n\n    return { signature, params: jsonParams }\n  }\n\n  _calcSignature (toSign) {\n    return crypto\n      .createHmac('sha1', this._authSecret)\n      .update(Buffer.from(toSign, 'utf-8'))\n      .digest('hex')\n  }\n\n  // Sets the multipart/form-data for POST, PUT and DELETE requests, including\n  // the streams, the signed params, and any additional fields.\n  _appendForm (req, params, fields) {\n    const sigData = this.calcSignature(params)\n    const jsonParams = sigData.params\n    const { signature } = sigData\n    const form = req.form()\n\n    form.append('params', jsonParams)\n\n    if (fields == null) {\n      fields = {}\n    }\n\n    for (let key in fields) {\n      let val = fields[key]\n      if (_.isObject(fields[key]) || _.isArray(fields[key])) {\n        val = JSON.stringify(fields[key])\n      }\n\n      form.append(key, val)\n    }\n\n    form.append('signature', signature)\n\n    _.each(this._streams, (value, key) => form.append(key, value))\n  }\n\n  // Implements HTTP GET query params, handling the case where the url already\n  // has params.\n  _appendParamsToUrl (url, params) {\n    const sigData = this.calcSignature(params)\n    const { signature } = sigData\n    let jsonParams = sigData.params\n\n    if (url.indexOf('?') === -1) {\n      url += `?signature=${signature}`\n    } else {\n      url += `&signature=${signature}`\n    }\n\n    jsonParams = encodeURIComponent(jsonParams)\n    url += `&params=${jsonParams}`\n\n    return url\n  }\n\n  // Responsible for including auth parameters in all requests\n  _prepareParams (params) {\n    if (params == null) {\n      params = {}\n    }\n    if (params.auth == null) {\n      params.auth = {}\n    }\n    if (params.auth.key == null) {\n      params.auth.key = this._authKey\n    }\n    if (params.auth.expires == null) {\n      params.auth.expires = this._getExpiresDate()\n    }\n\n    return JSON.stringify(params)\n  }\n\n  _getExpiresDate () {\n    const expiresDate = new Date()\n    expiresDate.setDate(expiresDate.getDate() + 1)\n    return expiresDate.toISOString()\n  }\n\n  _serviceUrl () {\n    return this._protocol + this._service\n  }\n\n  // Wrapper around __remoteJson which will retry in case of error\n  _remoteJson (opts, cb) {\n    const operation = retry.operation({\n      retries   : 5,\n      factor    : 3.28,\n      minTimeout: 1 * 1000,\n      maxTimeout: 8 * 1000,\n    })\n\n    operation.attempt(() => {\n      this.__remoteJson(opts, (err, result) => {\n        if (err != null) {\n          if (err.error === 'RATE_LIMIT_REACHED') {\n            console.warn(`Rate limit reached, retrying request in ${err.info.retryIn} seconds.`)\n            // FIXME uses private internals of node-retry\n            operation._timeouts.unshift(1000 * err.info.retryIn)\n            return operation.retry(err)\n          }\n\n          if (err.code === 'ENOTFOUND') {\n            console.warn(`The network connection is down, retrying request in 3 seconds.`)\n            // FIXME uses private internals of node-retry\n            operation._timeouts.unshift(3 * 1000)\n            return operation.retry(err)\n          }\n\n          if (err.error === 'GET_ACCOUNT_UNKNOWN_AUTH_KEY') {\n            console.warn(`Invalid auth key provided.`)\n            return cb(err)\n          }\n\n          if (err.error !== undefined) {\n            let msg = []\n            if (err.error) { msg.push(err.error) }\n            if (opts.url) { msg.push(opts.url) }\n            if (err.message) { msg.push(err.message) }\n            \n            console.warn(msg.join(' - '))\n            return cb(err)\n          }\n        }\n\n        if (operation.retry(err)) {\n          return\n        }\n\n        let mainError = null\n        if (err) {\n          mainError = operation.mainError()\n        }\n\n        cb(mainError, result)\n      })\n    })\n  }\n\n  // Responsible for making API calls. Automatically sends streams with any POST,\n  // PUT or DELETE requests. Automatically adds signature parameters to all\n  // requests. Also automatically parses the JSON response.\n  __remoteJson (opts, cb) {\n    const timeout = opts.timeout || 5000\n    let url = opts.url || null\n    const method = opts.method || 'get'\n\n    if (!url) {\n      const err = new Error('No url provided!')\n      return cb(err)\n    }\n\n    if (method === 'get' && opts.params != null) {\n      url = this._appendParamsToUrl(url, opts.params)\n    }\n\n    const requestOpts = {\n      uri: url,\n      timeout,\n    }\n\n    if (opts.headers != null) {\n      requestOpts.headers = opts.headers\n    }\n\n    const req = request[method](requestOpts, (err, { body, statusCode } = {}) => {\n      if (err) {\n        return cb(err)\n      }\n\n      // parse body\n      let result = null\n      try {\n        result = JSON.parse(body)\n      } catch (e) {\n        const abbr = `${body}`.substr(0, 255)\n        let msg = `Unable to parse JSON from '${requestOpts.uri}'. `\n        msg += `Code: ${statusCode}. Body: ${abbr}. `\n        return cb(new Error(msg))\n      }\n      if (statusCode !== 200 && statusCode !== 404 && statusCode >= 400 && statusCode <= 599) {\n        return cb(_.extend(new Error(), result))\n      }\n\n      return cb(null, result)\n    })\n\n    if (method === 'post' || method === 'put' || method === 'del') {\n      const extraData = Object.assign(\n        {tus_num_expected_upload_files: opts.tus_num_expected_upload_files},\n        opts.fields\n      )\n      this._appendForm(req, opts.params, extraData)\n    }\n  }\n\n  _sendTusRequest (opts, cb, onProgress) {\n    let uploadsDone = 0\n    const streamLabels = Object.keys(this._tus_streams)\n    const tlClient = this\n    let totalBytes = 0\n    let uploadedBytes = 0\n    onProgress = onProgress || (() => {})\n    for (const label of streamLabels) {\n      const file = this._tus_streams[label]\n      const uploadSize = fs.statSync(file.path).size // todo this will fail for streams without path\n      totalBytes += uploadSize\n      const filename = file.path ? path.basename(file.path) : label\n      const tusUpload = new tus.Upload(file, {\n        endpoint: opts.tus_url,\n        resume: true,\n        metadata: {\n          assembly_url: opts.assembly_ssl_url,\n          fieldname: label,\n          filename\n        },\n        uploadSize,\n        onError: cb,\n        onProgress(bytesUploaded) {\n          uploadedBytes += bytesUploaded\n          onProgress({\n            uploadProgress: { uploadedBytes, totalBytes }\n          })\n        },\n        onSuccess() {\n          uploadsDone++\n          if (uploadsDone === streamLabels.length) {\n            tlClient._tus_streams = {}\n            if (opts.waitForCompletion) {\n              tlClient.awaitAssemblyCompletion(opts.assembly_id, cb, onProgress)\n            }\n          }\n        }\n      })\n\n      tusUpload.start()\n    }\n  }\n}\n\nmodule.exports = TransloaditClient\n"]}